<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø³ÙŠØ³ØªÙ… Ø§Ø®Ø¯Ù…Ù†ÙŠ V9</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* Ø§Ù„Ø®Ø· ÙˆØ§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© */
        body { background-color: #f4f6f8; font-family: 'Cairo', sans-serif; }

        /* Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø¨Ø±Ø§Ù†Ø¯ */
        .bg-brand-orange { background-color: #ff6f00 !important; }
        .btn-brand-blue { background-color: #0d47a1; color: white; border: none; }
        .btn-brand-blue:hover { background-color: #002171; color: white; }
        .text-brand-orange { color: #ff6f00; }
        .text-brand-blue { color: #0d47a1; }

        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù„ÙˆØ¬Ùˆ Ù„Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø³ÙˆØ¯Ø§Ø¡ */
        .blend-logo { mix-blend-mode: screen; }
        .navbar-brand img { height: 50px; margin-left: 10px; }
        .login-box img { width: 100px; margin-bottom: 20px; }

        /* Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ */
        #loginOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #0d47a1; z-index: 9999;
            display: flex; justify-content: center; align-items: center;
        }
        .login-box { background: white; padding: 40px; border-radius: 15px; width: 350px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.3); }

        /* ÙƒØ±ÙˆØª Ø§Ù„Ø£ÙˆØ±Ø¯Ø±Ø§Øª (ØªØµÙ…ÙŠÙ… Ù…ÙˆØ­Ø¯) */
        .order-card { 
            background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-right: 6px solid #ccc; transition: all 0.2s; 
        }
        .order-card:hover { transform: translateY(-3px); box-shadow: 0 8px 15px rgba(0,0,0,0.1); }
        
        .status-new { border-right-color: #0d47a1; } /* Ø£Ø²Ø±Ù‚ */
        .status-done { border-right-color: #2e7d32; background-color: #f1f8e9; opacity: 0.9; } /* Ø£Ø®Ø¶Ø± */
        .status-pending { border-right-color: #ff6f00; background-color: #fff3e0; } /* Ø£ÙˆØ±Ù†Ø¬ */

        /* ÙƒØ±ÙˆØª Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª */
        .stats-card { background: #fff; border-radius: 10px; padding: 10px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); height: 100%; border: 1px solid #eee; }
        .stats-number { font-size: 20px; font-weight: bold; color: #0d47a1; }
        .driver-stat-box { border-top: 3px solid #ff6f00; }

        /* Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ ÙˆØ§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª */
        .handover-row { font-size: 0.85em; }
        .diff-pos { color: green; font-weight: bold; }
        .diff-neg { color: red; font-weight: bold; }
        .diff-zero { color: #aaa; }
        .note-text { white-space: pre-wrap; display: block; margin-top: 5px; color: #555; }
        .optional-input { background-color: #fafafa; border-color: #eee; }
    </style>
</head>
<body>

<div id="loginOverlay">
    <div class="login-box">
        <img src="https://i.ibb.co/sJRX04Z/92f0277e-3789-4969-9637-94d821d03bb2.jpg" alt="Logo" class="blend-logo">
        <h4 class="mb-4 text-brand-blue fw-bold">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h4>
        <input type="text" id="loginUser" class="form-control mb-3" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
        <input type="password" id="loginPass" class="form-control mb-3" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
        <button onclick="checkLogin()" class="btn btn-brand-orange w-100 fw-bold py-2 text-white">Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù†Ø¸Ø§Ù… ğŸš€</button>
    </div>
</div>

<nav class="navbar navbar-dark bg-brand-orange mb-4 shadow-sm">
    <div class="container">
        <span class="navbar-brand mb-0 h1 fw-bold d-flex align-items-center">
            <img src="https://i.ibb.co/sJRX04Z/92f0277e-3789-4969-9637-94d821d03bb2.jpg" alt="Logo" class="blend-logo" onerror="this.style.display='none'"> 
            <span>Ø§Ø®Ø¯Ù…Ù†ÙŠ - <span id="currentShiftDisplay" class="text-white small" style="opacity: 0.8;">...</span></span>
        </span>
        <div>
            <button onclick="openHandoverModal()" class="btn btn-light btn-sm fw-bold text-brand-orange me-2"><i class="fas fa-coins"></i> Ø§Ù„Ø¹Ù‡Ø¯Ø©</button>
            <button onclick="openDriverModal()" class="btn btn-outline-light btn-sm me-2"><i class="fas fa-users-cog"></i> Ø§Ù„Ø·ÙŠØ§Ø±ÙŠÙ†</button>
            <button onclick="exportToExcel()" class="btn btn-success btn-sm"><i class="fas fa-file-excel"></i> Ø¥ÙƒØ³ÙŠÙ„</button>
        </div>
    </div>
</nav>

<div class="container">
    <div class="row g-2 mb-4" id="statsBar"></div>

    <div class="card p-4 mb-4 shadow-sm border-0">
        <h5 id="formTitle" class="mb-3 text-brand-blue fw-bold"><i class="fas fa-plus-circle"></i> Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</h5>
        <input type="hidden" id="editOrderId">
        <div class="row g-3">
            
            <div class="col-md-12">
                <label class="text-muted small fw-bold">Ù†ÙˆØ¹ Ø§Ù„Ø£ÙˆØ±Ø¯Ø±</label>
                <select id="orderType" class="form-select border-primary" onchange="checkOrderType()">
                    <option value="normal">ğŸ‘¤ Ø£ÙˆØ±Ø¯Ø± Ø¹Ø§Ø¯ÙŠ (Ø·ÙŠØ§Ø±ÙŠ)</option>
                    <option value="store">ğŸª Ø£ÙˆØ±Ø¯Ø± Ù…Ø­Ù„</option>
                    <option value="online">ğŸŒ Ø£ÙˆØ±Ø¯Ø± Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†</option>
                </select>
            </div>

            <div class="col-md-3">
                <label class="text-muted small">Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ù„</label>
                <input type="text" id="storeName" class="form-control" placeholder="Ù…Ø·Ø¹Ù…...">
            </div>
            <div class="col-md-5">
                <label class="text-muted small">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£ÙˆØ±Ø¯Ø±</label>
                <input type="text" id="orderDetails" class="form-control" placeholder="ØªÙØ§ØµÙŠÙ„...">
            </div>
            
            <div class="col-md-2">
                <label class="text-muted small" id="lblPrice">Ø§Ù„Ø³Ø¹Ø±</label>
                <input type="number" id="deliveryPrice" class="form-control" placeholder="Ø¬.Ù…">
            </div>
            <div class="col-md-2">
                 <label class="text-muted small" id="lblPhone">Ù…ÙˆØ¨Ø§ÙŠÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
                <input type="text" id="clientPhone" class="form-control" placeholder="01xxxxxxxxx">
            </div>
            <div class="col-md-6">
                <label class="text-muted small" id="lblAddress">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
                <input type="text" id="address" class="form-control" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†...">
            </div>
            
            <div class="col-md-4">
                <label class="text-muted small">Ø§Ù„Ø·ÙŠØ§Ø±</label>
                <select id="driverSelect" class="form-select">
                    <option value="">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·ÙŠØ§Ø±ÙŠÙ†...</option>
                </select>
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button onclick="saveOrder()" id="saveBtn" class="btn btn-brand-blue w-100 fw-bold">Ø­ÙØ¸</button>
                <button onclick="cancelEdit()" id="cancelBtn" class="btn btn-secondary w-100 ms-2" style="display:none;">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="fw-bold text-dark"><i class="fas fa-list text-brand-orange"></i> Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø´ÙØª Ø§Ù„Ø­Ø§Ù„ÙŠ</h4>
        <button class="btn btn-outline-secondary btn-sm" onclick="toggleViewAll()" id="viewToggleBtn">Ø¹Ø±Ø¶ ÙƒÙ„ Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙŠÙˆÙ…</button>
    </div>
    <div id="ordersList">
        <p class="text-center text-muted py-5">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
    </div>
</div>

<div class="modal fade" id="driverModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·ÙŠØ§Ø±ÙŠÙ†</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="input-group mb-3">
                    <input type="text" id="newDriverName" class="form-control" placeholder="Ø§Ù„Ø§Ø³Ù…">
                    <input type="text" id="newDriverPhone" class="form-control" placeholder="Ø§Ù„Ø±Ù‚Ù…">
                    <button onclick="addNewDriver()" class="btn btn-primary">Ø¥Ø¶Ø§ÙØ©</button>
                </div>
                <ul class="list-group" id="driversListModal"></ul>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="handoverModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title text-dark fw-bold">ğŸ’° ØªÙ‚ÙÙŠÙ„ Ø§Ù„Ø´ÙØª ÙˆØªØ³Ù„ÙŠÙ… Ø§Ù„Ø¹Ù‡Ø¯Ø©</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row g-3 mb-4">
                    <div class="col-md-6">
                        <div class="card p-3 border-secondary h-100">
                            <h6 class="text-muted fw-bold">ğŸ’µ Ù†Ù‚Ø¯ÙŠØ© Ø§Ù„Ø¯Ø±Ø¬ (Ø§Ù„ÙƒØ§Ø´)</h6>
                            <div class="d-flex justify-content-between mb-2"><span>Ø§Ù„Ø¹Ù‡Ø¯Ø© Ø§Ù„Ø«Ø§Ø¨ØªØ©:</span><strong>1000 Ø¬.Ù…</strong></div>
                            <input type="number" id="cashFound" class="form-control form-control-lg border-success mb-2" placeholder="Ø¹Ø¯ÙŠØª ÙƒØ§Ù…ØŸ">
                            <label class="small text-muted">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø¯Ø±Ø¬:</label>
                            <textarea id="cashNote" class="form-control bg-light" rows="2" placeholder="Ø§ÙƒØªØ¨ Ù‡Ù†Ø§.."></textarea>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card p-3 border-secondary h-100">
                            <h6 class="text-muted fw-bold">ğŸ“± Ø§Ù„Ù…Ø­ÙØ¸Ø© (ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´)</h6>
                            <div class="d-flex justify-content-between mb-2"><span>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø«Ø§Ø¨Øª:</span><strong>1000 Ø¬.Ù…</strong></div>
                            <input type="number" id="walletFound" class="form-control form-control-lg border-success mb-2" placeholder="Ø§Ù„Ø±ØµÙŠØ¯ ÙƒØ§Ù…ØŸ">
                            <label class="small text-muted">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ø­ÙØ¸Ø©:</label>
                            <textarea id="walletNote" class="form-control bg-light" rows="2" placeholder="Ø§ÙƒØªØ¨ Ù‡Ù†Ø§.."></textarea>
                        </div>
                    </div>
                    <div class="col-12 mt-3">
                        <label class="text-muted fw-bold small">ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ø§Ù…Ø© ÙˆÙ…ØµØ§Ø±ÙŠÙ (Ø¨Ù†Ø²ÙŠÙ†ØŒ ØµÙŠØ§Ù†Ø©ØŒ Ø¥Ù„Ø®):</label>
                        <textarea id="generalHandoverNote" class="form-control border-dark" rows="2" placeholder="Ù…ØµØ§Ø±ÙŠÙ Ø¹Ø§Ù…Ø© Ù„Ù„Ø´ÙŠÙØª..."></textarea>
                    </div>
                    <div class="col-12 mt-2">
                        <button onclick="saveHandover()" class="btn btn-dark w-100 fw-bold py-2">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØ³Ù„ÙŠÙ… ğŸ’¾</button>
                    </div>
                </div>
                <hr>
                <div class="table-responsive">
                    <table class="table table-sm table-bordered text-center align-middle">
                        <thead class="table-light"><tr><th>Ø§Ù„Ø´ÙØª</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø¯Ø±Ø¬</th><th>Ø§Ù„Ù…Ø­ÙØ¸Ø©</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th></tr></thead>
                        <tbody id="handoverHistoryList"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js";
  import { getDatabase, ref, push, onValue, update, remove, set } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-database.js";

  // !!!!!!!!!!!!!! Ø¨ÙŠØ§Ù†Ø§ØªÙƒ !!!!!!!!!!!!!!
  const firebaseConfig = {
    apiKey: "AIzaSyCEBbuudt7RRp0ONywp8oit7TzoWgXo1PI",
    authDomain: "akhdemny-system.firebaseapp.com",
    databaseURL: "https://akhdemny-system-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "akhdemny-system",
    storageBucket: "akhdemny-system.firebasestorage.app",
    messagingSenderId: "831991915916",
    appId: "1:831991915916:web:1267ce815b1a04a6aca2a9"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  let driversList = [];
  let allOrdersData = {};
  let showAllOrders = false;
  const FIXED_CASH = 1000;
  const FIXED_WALLET = 1000;

  // --- Login Logic ---
  window.checkLogin = function() {
      const u = document.getElementById('loginUser').value;
      const p = document.getElementById('loginPass').value;
      if(u === 'ak' && p === 'ak1') {
          document.getElementById('loginOverlay').style.display = 'none';
          sessionStorage.setItem('isLoggedIn', 'true');
      } else {
          alert('Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø© âŒ');
      }
  }
  if(sessionStorage.getItem('isLoggedIn') === 'true') {
      document.getElementById('loginOverlay').style.display = 'none';
  }

  // --- Helpers ---
  function fixEgPhone(num) {
      if(!num) return "";
      let n = num.toString().replace(/\D/g, ''); 
      if (n.startsWith('01')) return '20' + n.substring(1); 
      if (n.startsWith('1')) return '20' + n; 
      return n; 
  }

  function getCurrentShift() {
      const hour = new Date().getHours();
      if (hour >= 9 && hour < 17) return { id: 1, name: "Ø´ÙØª ØµØ¨Ø§Ø­ÙŠ (9Øµ-5Ù…)" };
      if (hour >= 17 || hour < 1) return { id: 2, name: "Ø´ÙØª Ù…Ø³Ø§Ø¦ÙŠ (5Ù…-1Øµ)" };
      return { id: 3, name: "Ø´ÙØª Ø³Ù‡Ø±Ø© (1Øµ-9Øµ)" };
  }

  function updateShiftDisplay() {
      const shift = getCurrentShift();
      document.getElementById('currentShiftDisplay').innerText = shift.name;
  }
  setInterval(updateShiftDisplay, 60000);
  updateShiftDisplay();

  window.checkOrderType = function() {
      const type = document.getElementById('orderType').value;
      const inputs = ['deliveryPrice', 'clientPhone', 'address'];
      const isOptional = (type === 'store' || type === 'online');
      inputs.forEach((id) => {
          const el = document.getElementById(id);
          if(isOptional) { el.placeholder = "(Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"; el.classList.add('optional-input'); } 
          else { 
              if(id==='deliveryPrice') el.placeholder="Ø¬.Ù…"; 
              if(id==='clientPhone') el.placeholder="01xxxxxxxxx"; 
              if(id==='address') el.placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†..."; 
              el.classList.remove('optional-input'); 
          }
      });
  }

  // --- Drivers ---
  const driverModal = new bootstrap.Modal(document.getElementById('driverModal'));
  window.openDriverModal = () => driverModal.show();

  onValue(ref(db, 'drivers'), (snapshot) => {
      const list = document.getElementById('driversListModal');
      const select = document.getElementById('driverSelect');
      list.innerHTML = '';
      select.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø·ÙŠØ§Ø± --</option>';
      driversList = [];
      const data = snapshot.val();
      if(data) {
          Object.entries(data).forEach(([id, driver]) => {
              driversList.push({id, ...driver});
              const option = document.createElement('option');
              option.value = driver.name; option.dataset.phone = driver.phone; option.text = driver.name;
              select.appendChild(option);
              list.innerHTML += `<li class="list-group-item d-flex justify-content-between align-items-center">${driver.name} <span class="badge bg-light text-dark">${driver.phone}</span><button onclick="deleteDriver('${id}')" class="btn btn-danger btn-sm">Ø­Ø°Ù</button></li>`;
          });
      }
      refreshOrdersView(); 
  });

  window.addNewDriver = function() {
      const name = document.getElementById('newDriverName').value;
      let phone = document.getElementById('newDriverPhone').value;
      if(name && phone) {
          push(ref(db, 'drivers'), { name, phone: fixEgPhone(phone) });
          document.getElementById('newDriverName').value = ''; document.getElementById('newDriverPhone').value = '';
      }
  }
  window.deleteDriver = (id) => { if(confirm('Ø­Ø°ÙØŸ')) remove(ref(db, 'drivers/' + id)); };

  // --- Handover ---
  const handoverModal = new bootstrap.Modal(document.getElementById('handoverModal'));
  window.openHandoverModal = () => handoverModal.show();

  window.saveHandover = function() {
      const cash = document.getElementById('cashFound').value;
      const wallet = document.getElementById('walletFound').value;
      const cashNote = document.getElementById('cashNote').value;
      const walletNote = document.getElementById('walletNote').value;
      const generalNote = document.getElementById('generalHandoverNote').value;
      const shift = getCurrentShift();

      if(!cash || !wallet) { alert("Ù…Ù† ÙØ¶Ù„Ùƒ Ø§ÙƒØªØ¨ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ø¯Ø±Ø¬ ÙˆØ§Ù„Ù…Ø­ÙØ¸Ø©"); return; }

      push(ref(db, 'handovers'), {
          shiftName: shift.name, cashFound: cash, walletFound: wallet,
          cashNote: cashNote, walletNote: walletNote, generalNote: generalNote,
          timestamp: Date.now()
      });

      document.getElementById('cashFound').value = ''; document.getElementById('walletFound').value = '';
      document.getElementById('cashNote').value = ''; document.getElementById('walletNote').value = '';
      document.getElementById('generalHandoverNote').value = '';
      alert("ØªÙ… ØªØ³Ø¬ÙŠÙ„ ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø¹Ù‡Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­ âœ…");
  }

  onValue(ref(db, 'handovers'), (snapshot) => {
      const list = document.getElementById('handoverHistoryList');
      list.innerHTML = '';
      const data = snapshot.val();
      if(data) {
          const records = Object.values(data).reverse().slice(0, 10);
          records.forEach(rec => {
              const date = new Date(rec.timestamp).toLocaleString('ar-EG', {month:'numeric', day:'numeric', hour:'numeric', minute:'numeric'});
              const cashDiff = rec.cashFound - FIXED_CASH;
              const walletDiff = rec.walletFound - FIXED_WALLET;
              const cashClass = cashDiff > 0 ? 'diff-pos' : (cashDiff < 0 ? 'diff-neg' : 'diff-zero');
              const walletClass = walletDiff > 0 ? 'diff-pos' : (walletDiff < 0 ? 'diff-neg' : 'diff-zero');

              const cashDisplay = `<strong>${rec.cashFound}</strong> <span class="${cashClass}">(${cashDiff>0?'+':''}${cashDiff})</span>` + (rec.cashNote ? `<br><small class="note-text text-danger">â€¢ ${rec.cashNote}</small>` : '');
              const walletDisplay = `<strong>${rec.walletFound}</strong> <span class="${walletClass}">(${walletDiff>0?'+':''}${walletDiff})</span>` + (rec.walletNote ? `<br><small class="note-text text-danger">â€¢ ${rec.walletNote}</small>` : '');

              list.innerHTML += `<tr class="handover-row align-middle"><td>${rec.shiftName}</td><td>${date}</td><td>${cashDisplay}</td><td>${walletDisplay}</td><td class="text-start small text-muted"><span class="note-text">${rec.generalNote || '-'}</span></td></tr>`;
          });
      } else { list.innerHTML = '<tr><td colspan="5">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø³Ø§Ø¨Ù‚Ø©</td></tr>'; }
  });

  // --- Orders ---
  window.saveOrder = function() {
      const id = document.getElementById('editOrderId').value;
      const orderType = document.getElementById('orderType').value;
      const driverSelect = document.getElementById('driverSelect');
      const selectedDriverName = driverSelect.value;
      const shift = getCurrentShift();
      const storeName = document.getElementById('storeName').value;
      const details = document.getElementById('orderDetails').value;
      let price = document.getElementById('deliveryPrice').value;
      let phone = document.getElementById('clientPhone').value;
      let address = document.getElementById('address').value;

      if(!storeName || !details) { alert("Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ù„ ÙˆØ§Ù„ØªÙØ§ØµÙŠÙ„"); return; }
      if(orderType === 'normal' && (!price || !phone || !address)) { alert("Ø£ÙƒÙ…Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ÙˆØ±Ø¯Ø± Ø§Ù„Ø¹Ø§Ø¯ÙŠ"); return; }

      const orderData = {
          type: orderType, storeName: storeName, details: details, price: price,
          clientPhone: phone, address: address, driver: selectedDriverName,
          status: selectedDriverName ? 'new' : 'pending', shiftId: shift.id, timestamp: Date.now()
      };

      if(id) {
          if(allOrdersData[id].status === 'done') orderData.status = 'done';
          else if (orderData.driver) orderData.status = 'new';
          update(ref(db, 'orders/' + id), orderData);
          cancelEdit();
      } else { push(ref(db, 'orders'), orderData); }
      clearForm();
  }

  window.deleteOrder = function(id) {
      if(confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ')) {
          remove(ref(db, 'orders/' + id))
            .then(() => console.log("Deleted"))
            .catch(err => alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù"));
      }
  }

  onValue(ref(db, 'orders'), (snapshot) => {
      allOrdersData = snapshot.val() || {};
      refreshOrdersView();
  });

  function refreshOrdersView() {
      const list = document.getElementById('ordersList');
      list.innerHTML = '';
      if(!allOrdersData) { list.innerHTML = '<p class="text-center text-muted">Ù…ÙÙŠØ´ Ø·Ù„Ø¨Ø§Øª</p>'; return; }

      const orders = Object.entries(allOrdersData).reverse();
      const currentShiftId = getCurrentShift().id;
      
      const filteredOrders = orders.filter(([id, o]) => {
          const orderDate = new Date(o.timestamp).toDateString();
          const today = new Date().toDateString();
          if (showAllOrders && orderDate === today) return true;
          if (o.status !== 'done') return true; 
          return (o.shiftId === currentShiftId && orderDate === today);
      });

      updateDriverStatus(filteredOrders);
      calculateStats(filteredOrders);

      filteredOrders.forEach(([id, order]) => {
          let statusClass = order.status === 'new' ? 'status-new' : (order.status === 'done' ? 'status-done' : 'status-pending');
          let statusText = order.status === 'new' ? 'ğŸ›µ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙˆØµÙŠÙ„' : (order.status === 'done' ? 'âœ… ØªÙ… Ø§Ù„ØªÙˆØµÙŠÙ„' : 'âš ï¸ ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±');
          
          const driverObj = driversList.find(d => d.name === order.driver);
          const driverPhone = driverObj ? fixEgPhone(driverObj.phone) : '';
          
          // Ù‡Ù†Ø§ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: ØªÙˆØ­ÙŠØ¯ Ø§Ù„Ø´ÙƒÙ„ ÙˆØ¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨Ø§Ø¯Ø¬
          let typeLabel = "";
          if(order.type === 'store') typeLabel = ' <span class="badge bg-warning text-dark">Ù…Ø­Ù„</span>';
          else if(order.type === 'online') typeLabel = ' <span class="badge bg-info text-dark">Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†</span>';

          const msg = `*Ø£ÙˆØ±Ø¯Ø± Ø¬Ø¯ÙŠØ¯ ÙŠØ§ ${order.driver}* ğŸš€%0ağŸª *Ù…Ù†:* ${order.storeName}${typeLabel.replace(/<[^>]*>?/gm, '')}%0ağŸ§¾ *Ø§Ù„Ø£ÙˆØ±Ø¯Ø±:* ${order.details}%0ağŸ’µ *Ø§Ù„ØªÙˆØµÙŠÙ„:* ${order.price || '-'} Ø¬%0ağŸ“ *Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:* ${order.address || '-'}%0ağŸ“ *Ø§Ù„Ø¹Ù…ÙŠÙ„:* ${order.clientPhone || '-'}%0aâœ… *Ø§Ù„ØªØ£ÙƒÙŠØ¯:* https://akhdemny.github.io/akhdemny-system/driver.html?id=${id}`;
          
          let whatsappBtn = '';
          if(order.driver && order.status === 'new') {
              whatsappBtn = `<a href="whatsapp://send?phone=${driverPhone}&text=${msg}" class="btn btn-success btn-sm"><i class="fab fa-whatsapp"></i> Ø¥Ø±Ø³Ø§Ù„</a>`;
          } else if (!order.driver && order.type === 'normal') {
              statusText += ` <button class="btn btn-outline-warning btn-sm ms-2" onclick="editOrder('${id}')">ØªØ¹ÙŠÙŠÙ†</button>`;
          }

          // Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ù…ÙˆØ­Ø¯ Ù„ÙƒÙ„ Ø§Ù„ÙƒØ±ÙˆØª
          const html = `
              <div class="order-card ${statusClass}">
                  <div class="row align-items-center">
                      <div class="col-md-3 border-end">
                          <strong class="text-brand-blue">${order.storeName}</strong>${typeLabel}<br>
                          <small class="text-muted fw-bold">${order.price||0} Ø¬</small>
                      </div>
                      <div class="col-md-4 border-end">
                          <strong>${order.details}</strong><br>
                          <small class="text-muted">${order.address || 'Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†'}</small>
                      </div>
                      <div class="col-md-3">
                          <span class="badge bg-secondary mb-1">${order.driver||'-'}</span><br>
                          <strong>${statusText}</strong>
                      </div>
                      <div class="col-md-2 text-end">
                          ${whatsappBtn}
                          <button onclick="editOrder('${id}')" class="btn btn-outline-primary btn-sm mt-1"><i class="fas fa-edit"></i></button>
                          <button onclick="deleteOrder('${id}')" class="btn btn-outline-danger btn-sm mt-1 ms-1"><i class="fas fa-trash"></i></button>
                      </div>
                  </div>
              </div>`;
          list.innerHTML += html;
      });
  }

  function updateDriverStatus(currentOrders) {
      const select = document.getElementById('driverSelect');
      const busyDrivers = new Set();
      currentOrders.forEach(([id, o]) => {
          if(o.status === 'new' && o.driver) busyDrivers.add(o.driver);
      });
      Array.from(select.options).forEach(option => {
          if(option.value) {
              const isBusy = busyDrivers.has(option.value);
              option.text = (isBusy ? 'ğŸ”´ ' : 'ğŸŸ¢ ') + option.value + (isBusy ? ' (Ù…Ø´ØºÙˆÙ„)' : ' (Ù…ØªØ§Ø­)');
          }
      });
  }

  window.toggleViewAll = () => {
      showAllOrders = !showAllOrders;
      document.getElementById('viewToggleBtn').innerText = showAllOrders ? "Ø§Ù„Ø´ÙØª Ø§Ù„Ø­Ø§Ù„ÙŠ" : "Ø¹Ø±Ø¶ Ø§Ù„ÙŠÙˆÙ… ÙƒÙ„Ù‡";
      refreshOrdersView();
  }

  window.editOrder = function(id) {
      const order = allOrdersData[id];
      if(!order) return;
      document.getElementById('editOrderId').value = id;
      document.getElementById('orderType').value = order.type || 'normal';
      checkOrderType();
      document.getElementById('storeName').value = order.storeName;
      document.getElementById('orderDetails').value = order.details;
      document.getElementById('deliveryPrice').value = order.price;
      document.getElementById('clientPhone').value = order.clientPhone;
      document.getElementById('address').value = order.address;
      document.getElementById('driverSelect').value = order.driver || '';
      document.getElementById('saveBtn').innerText = "ØªØ­Ø¯ÙŠØ«";
      document.getElementById('cancelBtn').style.display = 'inline-block';
      window.scrollTo(0, 0);
  }

  window.cancelEdit = function() {
      clearForm();
      document.getElementById('editOrderId').value = '';
      document.getElementById('saveBtn').innerText = "Ø­ÙØ¸";
      document.getElementById('cancelBtn').style.display = 'none';
      document.getElementById('orderType').value = 'normal';
      checkOrderType();
  }

  function clearForm() {
      document.getElementById('storeName').value = '';
      document.getElementById('orderDetails').value = '';
      document.getElementById('deliveryPrice').value = '';
      document.getElementById('clientPhone').value = '';
      document.getElementById('address').value = '';
      document.getElementById('driverSelect').value = '';
  }

  function calculateStats(ordersArr) {
      const total = ordersArr.length;
      let done = 0;
      let waiting = 0;
      let driversCount = {};

      ordersArr.forEach(([k, o]) => {
          if(o.status === 'done') done++;
          if(o.status === 'pending') waiting++;
          if(o.driver) {
              driversCount[o.driver] = (driversCount[o.driver] || 0) + 1;
          }
      });

      let driversHtml = '';
      for (const [name, count] of Object.entries(driversCount)) {
          driversHtml += `
            <div class="col-6 col-md-2">
                <div class="stats-card driver-stat-box">
                    <small class="text-muted">${name}</small><br>
                    <span class="fw-bold text-dark">${count}</span>
                </div>
            </div>`;
      }

      document.getElementById('statsBar').innerHTML = `
          <div class="col-4 col-md-2">
              <div class="stats-card border-primary">
                  <div class="text-muted small">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</div>
                  <div class="stats-number text-brand-blue">${total}</div>
              </div>
          </div>
          <div class="col-4 col-md-2">
              <div class="stats-card border-success">
                  <div class="text-muted small">ØªÙ… Ø§Ù„ØªÙˆØµÙŠÙ„</div>
                  <div class="stats-number text-success">${done}</div>
              </div>
          </div>
          <div class="col-4 col-md-2">
              <div class="stats-card border-warning">
                  <div class="text-muted small">Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</div>
                  <div class="stats-number text-warning">${waiting}</div>
              </div>
          </div>
          ${driversHtml}
      `;
  }
  
  window.exportToExcel = function() {
      const rows = [["Type", "Store", "Details", "Price", "Address", "Phone", "Driver", "Status", "Date"]];
      Object.values(allOrdersData).forEach(o => {
          const date = new Date(o.timestamp).toLocaleString('ar-EG');
          rows.push([o.type, o.storeName, o.details, o.price, o.address, o.clientPhone, o.driver, o.status, date]);
      });
      let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
      rows.forEach(r => { csvContent += r.map(e => `"${e || ''}"`).join(",") + "\r\n"; });
      const link = document.createElement("a");
      link.setAttribute("href", encodeURI(csvContent));
      link.setAttribute("download", "akhdemny_orders.csv");
      document.body.appendChild(link);
      link.click();
  }

  import "https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js";
</script>
</body>
</html>
