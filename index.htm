<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… - Ø§Ø®Ø¯Ù…Ù†ÙŠ V4</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .order-card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-right: 6px solid #ccc; transition: transform 0.2s; }
        .order-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .status-new { border-right-color: #0d6efd; }
        .status-done { border-right-color: #198754; background-color: #f8fffb; opacity: 0.8; }
        .status-pending { border-right-color: #ffc107; background-color: #fffbf0; }
        .stats-card { background: #fff; border-radius: 10px; padding: 15px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .stats-number { font-size: 24px; font-weight: bold; color: #0d6efd; }
        .shift-badge { position: fixed; bottom: 20px; left: 20px; background: #343a40; color: #fff; padding: 10px 20px; border-radius: 50px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 1000; font-weight: bold; }
        .pickup-info { background-color: #e3f2fd; padding: 10px; border-radius: 8px; margin-bottom: 10px; border: 1px dashed #0d6efd; }
    </style>
</head>
<body>

<nav class="navbar navbar-dark bg-dark mb-4">
    <div class="container">
        <span class="navbar-brand mb-0 h1">ğŸ›µ Ø§Ø®Ø¯Ù…Ù†ÙŠ - <span id="currentShiftDisplay" class="text-warning small">...</span></span>
        <div>
            <button onclick="openStoreModal()" class="btn btn-outline-warning btn-sm me-2"><i class="fas fa-store"></i> Ø§Ù„Ù…Ø­Ù„Ø§Øª</button>
            <button onclick="openDriverModal()" class="btn btn-outline-light btn-sm me-2"><i class="fas fa-users-cog"></i> Ø§Ù„Ø·ÙŠØ§Ø±ÙŠÙ†</button>
            <button onclick="exportToExcel()" class="btn btn-success btn-sm"><i class="fas fa-file-excel"></i> Ø¥ÙƒØ³ÙŠÙ„</button>
        </div>
    </div>
</nav>

<div class="container">
    <div class="row mb-4" id="statsBar"></div>

    <div class="card p-4 mb-4 shadow-sm">
        <h5 id="formTitle" class="mb-3"><i class="fas fa-plus-circle"></i> Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</h5>
        <input type="hidden" id="editOrderId">
        
        <div class="row g-3">
            <div class="col-12">
                <div class="pickup-info row g-2">
                    <div class="col-md-4">
                        <label class="text-muted small">Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ù„ / Ø§Ù„Ø³ÙŠÙ„Ø± (Ø§Ø³ØªÙ„Ø§Ù… Ù…Ù†)</label>
                        <input class="form-control fw-bold" list="storesOptions" id="storeName" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ù„..." onchange="autoFillStore()">
                        <datalist id="storesOptions"></datalist>
                    </div>
                    <div class="col-md-8">
                        <label class="text-muted small">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… (Ù…ÙƒØ§Ù† Ø§Ù„Ù…Ø­Ù„/Ø§Ù„Ø¨ÙŠØª)</label>
                        <input type="text" id="pickupAddress" class="form-control" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø­Ù„ Ø§Ù„Ù„ÙŠ Ù‡Ù†Ø¬ÙŠØ¨ Ù…Ù†Ù‡...">
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <label class="text-muted small">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£ÙˆØ±Ø¯Ø±</label>
                <input type="text" id="orderDetails" class="form-control" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø·Ù„Ø¨Ø§Øª...">
            </div>
            <div class="col-md-2">
                <label class="text-muted small">Ø³Ø¹Ø± Ø§Ù„ØªÙˆØµÙŠÙ„</label>
                <input type="number" id="deliveryPrice" class="form-control" placeholder="Ø¬.Ù…">
            </div>
            
            <div class="col-md-4">
                 <label class="text-muted small">Ù…ÙˆØ¨Ø§ÙŠÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ„ (Ø§Ù„Ø²Ø¨ÙˆÙ†)</label>
                <input type="text" id="clientPhone" class="form-control" placeholder="01xxxxxxxxx">
            </div>
            <div class="col-md-8">
                <label class="text-muted small">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„ (Ù‡Ù†ÙˆØµÙ„ ÙÙŠÙ†)</label>
                <input type="text" id="clientAddress" class="form-control" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø²Ø¨ÙˆÙ† Ø¨Ø§Ù„ØªÙØµÙŠÙ„...">
            </div>

            <div class="col-md-4">
                <label class="text-muted small">Ø§Ù„Ø·ÙŠØ§Ø±</label>
                <select id="driverSelect" class="form-select">
                    <option value="">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</option>
                </select>
            </div>

            <div class="col-md-12">
                <button onclick="saveOrder()" id="saveBtn" class="btn btn-primary w-100 fw-bold py-2">Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨</button>
                <button onclick="cancelEdit()" id="cancelBtn" class="btn btn-secondary w-100 mt-2" style="display:none;">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4><i class="fas fa-list"></i> Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø´ÙØª Ø§Ù„Ø­Ø§Ù„ÙŠ</h4>
        <button class="btn btn-outline-secondary btn-sm" onclick="toggleViewAll()" id="viewToggleBtn">Ø¹Ø±Ø¶ ÙƒÙ„ Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙŠÙˆÙ…</button>
    </div>
    <div id="ordersList">
        <p class="text-center text-muted">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
    </div>
</div>

<div class="modal fade" id="driverModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·ÙŠØ§Ø±ÙŠÙ†</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="input-group mb-3">
                    <input type="text" id="newDriverName" class="form-control" placeholder="Ø§Ù„Ø§Ø³Ù…">
                    <input type="text" id="newDriverPhone" class="form-control" placeholder="Ù…ÙˆØ¨Ø§ÙŠÙ„">
                    <button onclick="addNewDriver()" class="btn btn-primary">Ø¥Ø¶Ø§ÙØ©</button>
                </div>
                <ul class="list-group" id="driversListModal"></ul>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="storeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø­Ù„Ø§Øª / Ø§Ù„Ø³ÙŠÙ„Ø±Ø²</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="small text-muted">Ø³Ø¬Ù„ Ø§Ù„Ù…Ø­Ù„Ø§Øª Ù‡Ù†Ø§ Ø¹Ø´Ø§Ù† ØªØ¸Ù‡Ø±Ù„Ùƒ Ø¨Ø³Ø±Ø¹Ø© ÙˆØ£Ù†Øª Ø¨ØªØ¹Ù…Ù„ Ø§Ù„Ø£ÙˆØ±Ø¯Ø±.</p>
                <div class="mb-3">
                    <input type="text" id="newStoreName" class="form-control mb-2" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ù„ (Ù…Ø«Ù„: Ù…Ø·Ø¨Ø® Ø£Ù… Ø£Ø­Ù…Ø¯)">
                    <input type="text" id="newStoreAddress" class="form-control mb-2" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø«Ø§Ø¨Øª">
                    <button onclick="addNewStore()" class="btn btn-warning w-100">Ø­ÙØ¸ Ø§Ù„Ù…Ø­Ù„</button>
                </div>
                <hr>
                <h6>Ø§Ù„Ù…Ø­Ù„Ø§Øª Ø§Ù„Ù…Ø³Ø¬Ù„Ø©:</h6>
                <ul class="list-group" id="storesListModal"></ul>
            </div>
        </div>
    </div>
</div>

<div class="shift-badge" id="shiftBadge">
    <i class="fas fa-clock"></i> <span id="shiftText">...</span>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js";
  import { getDatabase, ref, push, onValue, update, remove, set } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-database.js";

  // !!!!!!!!!!!!!! Ø¨ÙŠØ§Ù†Ø§ØªÙƒ !!!!!!!!!!!!!!
  const firebaseConfig = {
    apiKey: "AIzaSyCEBbuudt7RRp0ONywp8oit7TzoWgXo1PI",
    authDomain: "akhdemny-system.firebaseapp.com",
    databaseURL: "https://akhdemny-system-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "akhdemny-system",
    storageBucket: "akhdemny-system.firebasestorage.app",
    messagingSenderId: "831991915916",
    appId: "1:831991915916:web:1267ce815b1a04a6aca2a9"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  let driversList = [];
  let storesDB = []; // Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„Ø§Øª
  let allOrdersData = {};
  let showAllOrders = false;

  // Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø©
  function fixEgPhone(num) {
      if(!num) return "";
      let n = num.toString().replace(/\D/g, '');
      if (n.startsWith('01')) return '20' + n.substring(1);
      if (n.startsWith('1')) return '20' + n;
      return n;
  }

  function getCurrentShift() {
      const hour = new Date().getHours();
      if (hour >= 9 && hour < 17) return { id: 1, name: "Ø´ÙØª ØµØ¨Ø§Ø­ÙŠ (9Øµ - 5Ù…) â˜€ï¸" };
      if (hour >= 17 || hour < 1) return { id: 2, name: "Ø´ÙØª Ù…Ø³Ø§Ø¦ÙŠ (5Ù… - 1Øµ) ğŸŒ™" };
      return { id: 3, name: "Ø´ÙØª Ø³Ù‡Ø±Ø© (1Øµ - 9Øµ) ğŸ¦‰" };
  }
  
  function updateShiftDisplay() {
      const shift = getCurrentShift();
      document.getElementById('currentShiftDisplay').innerText = shift.name;
      document.getElementById('shiftText').innerText = shift.name;
  }
  setInterval(updateShiftDisplay, 60000);
  updateShiftDisplay();

  // ================= Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·ÙŠØ§Ø±ÙŠÙ† =================
  const driverModal = new bootstrap.Modal(document.getElementById('driverModal'));
  window.openDriverModal = () => driverModal.show();

  onValue(ref(db, 'drivers'), (snapshot) => {
      const list = document.getElementById('driversListModal');
      const select = document.getElementById('driverSelect');
      list.innerHTML = '';
      select.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø·ÙŠØ§Ø± --</option>';
      driversList = [];

      const data = snapshot.val();
      if(data) {
          Object.entries(data).forEach(([id, driver]) => {
              driversList.push({id, ...driver});
              
              const option = document.createElement('option');
              option.value = driver.name;
              option.dataset.phone = driver.phone;
              option.text = driver.name;
              select.appendChild(option);

              list.innerHTML += `
                  <li class="list-group-item d-flex justify-content-between align-items-center">
                      ${driver.name}
                      <button onclick="deleteDriver('${id}')" class="btn btn-danger btn-sm">Ø­Ø°Ù</button>
                  </li>`;
          });
      }
      refreshOrdersView();
  });

  window.addNewDriver = function() {
      const name = document.getElementById('newDriverName').value;
      let phone = document.getElementById('newDriverPhone').value;
      if(name && phone) {
          push(ref(db, 'drivers'), { name, phone: fixEgPhone(phone) });
          document.getElementById('newDriverName').value = '';
          document.getElementById('newDriverPhone').value = '';
      }
  }
  window.deleteDriver = (id) => { if(confirm('Ø­Ø°ÙØŸ')) remove(ref(db, 'drivers/' + id)); };

  // ================= Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø­Ù„Ø§Øª (NEW) =================
  const storeModal = new bootstrap.Modal(document.getElementById('storeModal'));
  window.openStoreModal = () => storeModal.show();

  onValue(ref(db, 'stores'), (snapshot) => {
      const list = document.getElementById('storesListModal');
      const dataList = document.getElementById('storesOptions');
      list.innerHTML = '';
      dataList.innerHTML = '';
      storesDB = [];

      const data = snapshot.val();
      if(data) {
          Object.entries(data).forEach(([id, store]) => {
              storesDB.push({id, ...store});
              
              // Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª
              const option = document.createElement('option');
              option.value = store.name;
              dataList.appendChild(option);

              // Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© ÙÙŠ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
              list.innerHTML += `
                  <li class="list-group-item">
                      <div class="d-flex justify-content-between">
                          <strong>${store.name}</strong>
                          <button onclick="deleteStore('${id}')" class="btn btn-danger btn-sm">x</button>
                      </div>
                      <small class="text-muted">${store.address}</small>
                  </li>`;
          });
      }
  });

  window.addNewStore = function() {
      const name = document.getElementById('newStoreName').value;
      const address = document.getElementById('newStoreAddress').value;
      if(name && address) {
          push(ref(db, 'stores'), { name, address });
          document.getElementById('newStoreName').value = '';
          document.getElementById('newStoreAddress').value = '';
      }
  }
  window.deleteStore = (id) => { if(confirm('Ø­Ø°Ù Ø§Ù„Ù…Ø­Ù„ØŸ')) remove(ref(db, 'stores/' + id)); };

  // Ø§Ù„ØªØ¹Ø¨Ø¦Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø­Ù„
  window.autoFillStore = function() {
      const inputVal = document.getElementById('storeName').value;
      const store = storesDB.find(s => s.name === inputVal);
      if(store) {
          document.getElementById('pickupAddress').value = store.address;
      }
  }

  // ================= Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª =================
  window.saveOrder = function() {
      const id = document.getElementById('editOrderId').value;
      const driverSelect = document.getElementById('driverSelect');
      const selectedDriverName = driverSelect.value;
      const shift = getCurrentShift();

      const orderData = {
          storeName: document.getElementById('storeName').value,
          pickupAddress: document.getElementById('pickupAddress').value,
          details: document.getElementById('orderDetails').value,
          price: document.getElementById('deliveryPrice').value,
          clientPhone: document.getElementById('clientPhone').value,
          clientAddress: document.getElementById('clientAddress').value,
          driver: selectedDriverName,
          status: selectedDriverName ? 'new' : 'pending',
          shiftId: shift.id,
          timestamp: Date.now()
      };

      if(!orderData.storeName || !orderData.details) { alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©"); return; }

      if(id) {
          if(allOrdersData[id].status === 'done') orderData.status = 'done';
          else if (orderData.driver) orderData.status = 'new';
          update(ref(db, 'orders/' + id), orderData);
          cancelEdit();
      } else {
          push(ref(db, 'orders'), orderData);
      }
      clearForm();
  }

  onValue(ref(db, 'orders'), (snapshot) => {
      allOrdersData = snapshot.val() || {};
      refreshOrdersView();
  });

  function refreshOrdersView() {
      const list = document.getElementById('ordersList');
      list.innerHTML = '';
      if(!allOrdersData) { list.innerHTML = '<p class="text-center">Ù…ÙÙŠØ´ Ø·Ù„Ø¨Ø§Øª</p>'; return; }

      const orders = Object.entries(allOrdersData).reverse();
      const currentShiftId = getCurrentShift().id;
      
      const filteredOrders = orders.filter(([id, o]) => {
          const orderDate = new Date(o.timestamp).toDateString();
          const today = new Date().toDateString();
          if (showAllOrders && orderDate === today) return true;
          if (o.status !== 'done') return true; 
          return (o.shiftId === currentShiftId && orderDate === today);
      });

      updateDriverStatus(filteredOrders);
      calculateStats(filteredOrders);

      filteredOrders.forEach(([id, order]) => {
          let statusClass = order.status === 'new' ? 'status-new' : (order.status === 'done' ? 'status-done' : 'status-pending');
          let statusText = order.status === 'new' ? 'ğŸ›µ Ø¬Ø§Ø±ÙŠ' : (order.status === 'done' ? 'âœ… ØªÙ…' : 'âš ï¸ Ø§Ù†ØªØ¸Ø§Ø±');
          
          const driverObj = driversList.find(d => d.name === order.driver);
          const driverPhone = driverObj ? fixEgPhone(driverObj.phone) : '';
          
          // Ø±Ø³Ø§Ù„Ø© Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ Ø§Ù„Ù…ØªØ·ÙˆØ±Ø©
          const msg = `*Ø£ÙˆØ±Ø¯Ø± Ø¬Ø¯ÙŠØ¯ ÙŠØ§ ${order.driver}* ğŸš€%0a` +
                      `ğŸª *Ø§Ø³ØªÙ„Ø§Ù… Ù…Ù†:* ${order.storeName}%0a` +
                      `ğŸ“ *Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…:* ${order.pickupAddress}%0a` +
                      `------------------%0a` +
                      `ğŸ§¾ *Ø§Ù„Ø£ÙˆØ±Ø¯Ø±:* ${order.details}%0a` +
                      `ğŸ’µ *Ø§Ù„ØªÙˆØµÙŠÙ„:* ${order.price} Ø¬%0a` +
                      `ğŸ‘¤ *Ø§Ù„Ø¹Ù…ÙŠÙ„:* ${order.clientAddress}%0a` +
                      `ğŸ“ *Ù…ÙˆØ¨Ø§ÙŠÙ„:* ${order.clientPhone}%0a` +
                      `âœ… *ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…:* https://akhdemny.github.io/akhdemny-system/driver.html?id=${id}`;
          
          let whatsappBtn = '';
          if(order.driver && order.status === 'new') {
              whatsappBtn = `<a href="whatsapp://send?phone=${driverPhone}&text=${msg}" class="btn btn-success btn-sm"><i class="fab fa-whatsapp"></i> Ø¥Ø±Ø³Ø§Ù„</a>`;
          } else if (!order.driver) {
              statusText += ` <button class="btn btn-outline-warning btn-sm ms-2" onclick="editOrder('${id}')">ØªØ¹ÙŠÙŠÙ†</button>`;
          }

          const html = `
              <div class="order-card ${statusClass}">
                  <div class="row align-items-center">
                      <div class="col-md-3 border-end">
                          <strong class="text-primary">${order.storeName}</strong><br>
                          <small class="text-muted" style="font-size:0.7em">${order.pickupAddress}</small>
                      </div>
                      <div class="col-md-4 border-end">
                          <strong>${order.details}</strong><br>
                          <i class="fas fa-map-marker-alt text-danger"></i> <small>${order.clientAddress}</small>
                      </div>
                      <div class="col-md-3">
                          <span class="badge bg-secondary">${order.driver||'-'}</span>
                          <strong class="d-block mt-1">${statusText}</strong>
                      </div>
                      <div class="col-md-2 text-end">${whatsappBtn} <button onclick="editOrder('${id}')" class="btn btn-outline-primary btn-sm mt-1">ØªØ¹Ø¯ÙŠÙ„</button></div>
                  </div>
              </div>`;
          list.innerHTML += html;
      });
  }

  function updateDriverStatus(currentOrders) {
      const select = document.getElementById('driverSelect');
      const busyDrivers = new Set();
      currentOrders.forEach(([id, o]) => {
          if(o.status === 'new' && o.driver) busyDrivers.add(o.driver);
      });
      Array.from(select.options).forEach(option => {
          if(option.value) {
              const isBusy = busyDrivers.has(option.value);
              option.text = (isBusy ? 'ğŸ”´ ' : 'ğŸŸ¢ ') + option.value + (isBusy ? ' (Ù…Ø´ØºÙˆÙ„)' : ' (Ù…ØªØ§Ø­)');
          }
      });
  }

  window.toggleViewAll = function() {
      showAllOrders = !showAllOrders;
      document.getElementById('viewToggleBtn').innerText = showAllOrders ? "Ø§Ù„Ø´ÙØª Ø§Ù„Ø­Ø§Ù„ÙŠ" : "Ø¹Ø±Ø¶ Ø§Ù„ÙŠÙˆÙ… ÙƒÙ„Ù‡";
      refreshOrdersView();
  }

  window.editOrder = function(id) {
      const order = allOrdersData[id];
      if(!order) return;
      document.getElementById('editOrderId').value = id;
      document.getElementById('storeName').value = order.storeName;
      document.getElementById('pickupAddress').value = order.pickupAddress; // Ø¬Ø¯ÙŠØ¯
      document.getElementById('orderDetails').value = order.details;
      document.getElementById('deliveryPrice').value = order.price;
      document.getElementById('clientPhone').value = order.clientPhone;
      document.getElementById('clientAddress').value = order.clientAddress;
      document.getElementById('driverSelect').value = order.driver || '';
      document.getElementById('saveBtn').innerText = "ØªØ­Ø¯ÙŠØ«";
      document.getElementById('cancelBtn').style.display = 'inline-block';
      window.scrollTo(0, 0);
  }

  window.cancelEdit = function() {
      clearForm();
      document.getElementById('editOrderId').value = '';
      document.getElementById('saveBtn').innerText = "Ø­ÙØ¸";
      document.getElementById('cancelBtn').style.display = 'none';
  }

  function clearForm() {
      document.getElementById('storeName').value = '';
      document.getElementById('pickupAddress').value = '';
      document.getElementById('orderDetails').value = '';
      document.getElementById('deliveryPrice').value = '';
      document.getElementById('clientPhone').value = '';
      document.getElementById('clientAddress').value = '';
      document.getElementById('driverSelect').value = '';
  }

  function calculateStats(ordersArr) {
      const total = ordersArr.length;
      let done = 0;
      ordersArr.forEach(o => { if(o.status === 'done') done++; });
      document.getElementById('statsBar').innerHTML = `
          <div class="col-md-6 mb-2"><div class="stats-card border-primary"><div>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</div><div class="stats-number">${total}</div></div></div>
          <div class="col-md-6 mb-2"><div class="stats-card border-success"><div>ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…</div><div class="stats-number text-success">${done}</div></div></div>
      `;
  }
  
  window.exportToExcel = function() {
      const rows = [["Store", "Pickup Addr", "Details", "Price", "Client Addr", "Client Phone", "Driver", "Status", "Date"]];
      Object.values(allOrdersData).forEach(o => {
          const date = new Date(o.timestamp).toLocaleString('ar-EG');
          rows.push([o.storeName, o.pickupAddress, o.details, o.price, o.clientAddress, o.clientPhone, o.driver, o.status, date]);
      });
      let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
      rows.forEach(r => { csvContent += r.map(e => `"${e || ''}"`).join(",") + "\r\n"; });
      const link = document.createElement("a");
      link.setAttribute("href", encodeURI(csvContent));
      link.setAttribute("download", "akhdemny_orders.csv");
      document.body.appendChild(link);
      link.click();
  }

  import "https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js";
</script>
</body>
</html>
