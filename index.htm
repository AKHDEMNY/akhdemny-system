<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… - Ø§Ø®Ø¯Ù…Ù†ÙŠ V2</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .order-card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-right: 6px solid #ccc; transition: transform 0.2s; }
        .order-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        
        /* Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø·Ù„Ø¨ */
        .status-new { border-right-color: #0d6efd; } /* Ø£Ø²Ø±Ù‚: Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙˆØµÙŠÙ„ */
        .status-done { border-right-color: #198754; background-color: #f8fffb; opacity: 0.8; } /* Ø£Ø®Ø¶Ø±: ØªÙ… */
        .status-pending { border-right-color: #ffc107; background-color: #fffbf0; } /* Ø£ØµÙØ±: ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± (Ø¨Ø¯ÙˆÙ† Ø·ÙŠØ§Ø±) */

        .stats-card { background: #fff; border-radius: 10px; padding: 15px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .stats-number { font-size: 24px; font-weight: bold; color: #0d6efd; }
    </style>
</head>
<body>

<nav class="navbar navbar-dark bg-dark mb-4">
    <div class="container">
        <span class="navbar-brand mb-0 h1">ğŸ›µ Ø§Ø®Ø¯Ù…Ù†ÙŠ - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</span>
        <button onclick="exportToExcel()" class="btn btn-success btn-sm"><i class="fas fa-file-excel"></i> ØªØ­Ù…ÙŠÙ„ Ø´ÙŠØª Ø¥ÙƒØ³ÙŠÙ„</button>
    </div>
</nav>

<div class="container">
    
    <div class="row mb-4" id="statsBar">
        </div>

    <div class="card p-4 mb-4 shadow-sm">
        <h5 id="formTitle" class="mb-3"><i class="fas fa-plus-circle"></i> Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</h5>
        <input type="hidden" id="editOrderId"> <div class="row g-3">
            <div class="col-md-3">
                <label class="form-label text-muted small">Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ù„ (Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…)</label>
                <input type="text" id="storeName" class="form-control" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø·Ø¹Ù… Ø§Ù„Ø¨Ø±Ù†Ø³">
            </div>
            <div class="col-md-5">
                <label class="form-label text-muted small">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£ÙˆØ±Ø¯Ø±</label>
                <input type="text" id="orderDetails" class="form-control" placeholder="2 ÙƒØ´Ø±ÙŠ + Ø¨ÙŠØ¨Ø³ÙŠ...">
            </div>
            <div class="col-md-2">
                <label class="form-label text-muted small">Ø³Ø¹Ø± Ø§Ù„ØªÙˆØµÙŠÙ„</label>
                <input type="number" id="deliveryPrice" class="form-control" placeholder="Ø¬.Ù…">
            </div>
            <div class="col-md-2">
                 <label class="form-label text-muted small">Ø±Ù‚Ù… Ù…ÙˆØ¨Ø§ÙŠÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
                <input type="text" id="clientPhone" class="form-control" placeholder="01xxxxxxxxx">
            </div>
            <div class="col-md-6">
                <label class="form-label text-muted small">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
                <input type="text" id="address" class="form-control" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¨Ø§Ù„ØªÙØµÙŠÙ„...">
            </div>
            
            <div class="col-md-4">
                <label class="form-label text-muted small">ØªØ¹ÙŠÙŠÙ† Ø·ÙŠØ§Ø± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                <select id="driverSelect" class="form-select">
                    </select>
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button onclick="saveOrder()" id="saveBtn" class="btn btn-primary w-100 fw-bold">Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨</button>
                <button onclick="cancelEdit()" id="cancelBtn" class="btn btn-secondary w-100 ms-2" style="display:none;">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <h4 class="mb-3"><i class="fas fa-list"></i> Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h4>
    <div id="ordersList">
        <p class="text-center text-muted">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±...</p>
    </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js";
  import { getDatabase, ref, push, onValue, update } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-database.js";

  // !!!!!!!!!!!!!! Ø­Ø· Ø¨ÙŠØ§Ù†Ø§Øª Firebase Ø¨ØªØ§Ø¹ØªÙƒ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© Ù‡Ù†Ø§ !!!!!!!!!!!!!!
  const firebaseConfig = {
    apiKey: "AIzaSyCEBbuudt7RRp0ONywp8oit7TzoWgXo1PI",
    authDomain: "akhdemny-system.firebaseapp.com",
    databaseURL: "https://akhdemny-system-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "akhdemny-system",
    storageBucket: "akhdemny-system.firebasestorage.app",
    messagingSenderId: "831991915916",
    appId: "1:831991915916:web:1267ce815b1a04a6aca2a9"
  };
  // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const SITE_URL = window.location.href.replace('index.html', '');

  // 1. Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·ÙŠØ§Ø±ÙŠÙ† (Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø±Ù‚Ù…)
  // Ø£ÙŠ Ø§Ø³Ù… ØªØ¶ÙŠÙÙ‡ Ù‡Ù†Ø§ Ù‡ÙŠØ¸Ù‡Ø± ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙˆØªØ´ØªØºÙ„ Ø¹Ù„ÙŠÙ‡ Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ù†Ø´ØºØ§Ù„ Ø§ÙˆØªÙˆÙ…Ø§ØªÙŠÙƒ
  const driversDB = [
      { name: "Ø¹Ù…Ø±", phone: "201032772469" },
      { name: "Ø§Ø¨Ø±Ø§Ù‡ÙŠÙ…", phone: "201229061305" },
      { name: "Ù…Ø­Ù…Ø¯ (ØªØ¬Ø±Ø¨Ø©)", phone: "201000000000" } // Ù…Ø«Ø§Ù„
  ];

  let allOrdersData = {}; // Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¯Ø§ØªØ§ Ø¹Ø´Ø§Ù† Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙˆØ§Ù„Ø§Ø­ØµØ§Ø¦ÙŠØ§Øª

  // 2. Ø¯Ø§Ù„Ø© Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨ (ØªØ´ØªØºÙ„ Ù„Ù„Ø¬Ø¯ÙŠØ¯ ÙˆÙ„Ù„ØªØ¹Ø¯ÙŠÙ„)
  window.saveOrder = function() {
      const id = document.getElementById('editOrderId').value; // Ù„Ùˆ ÙØ§Ø¶ÙŠ ÙŠØ¨Ù‚Ù‰ Ø¬Ø¯ÙŠØ¯ØŒ Ù„Ùˆ ÙÙŠÙ‡ Ù‚ÙŠÙ…Ø© ÙŠØ¨Ù‚Ù‰ ØªØ¹Ø¯ÙŠÙ„
      
      const orderData = {
          storeName: document.getElementById('storeName').value,
          details: document.getElementById('orderDetails').value,
          price: document.getElementById('deliveryPrice').value,
          clientPhone: document.getElementById('clientPhone').value,
          address: document.getElementById('address').value,
          driver: document.getElementById('driverSelect').value,
          // Ù„Ùˆ Ø§Ø®ØªØ±Ù†Ø§ Ø·ÙŠØ§Ø± ØªØ¨Ù‚Ù‰ Ø§Ù„Ø­Ø§Ù„Ø© new (Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙˆØµÙŠÙ„)ØŒ Ù„Ùˆ Ù„Ø³Ù‡ ØªØ¨Ù‚Ù‰ pending
          status: document.getElementById('driverSelect').value ? 'new' : 'pending',
          timestamp: Date.now()
      };

      // Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø¨Ø³ÙŠØ·
      if(!orderData.storeName || !orderData.details) {
          alert("Ù„Ø§Ø²Ù… ØªÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ù„ ÙˆØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£ÙˆØ±Ø¯Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„");
          return;
      }

      if(id) {
          // Ø­Ø§Ù„Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Update
          // Ù†Ø­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù„Ùˆ Ù‡ÙŠ done
          if(allOrdersData[id].status === 'done') orderData.status = 'done';
          else if (orderData.driver) orderData.status = 'new';
          
          update(ref(db, 'orders/' + id), orderData);
          cancelEdit(); // Ø±Ø¬ÙˆØ¹ Ù„Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ø§Ø¯ÙŠ
      } else {
          // Ø­Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯ Create
          push(ref(db, 'orders'), orderData);
      }

      clearForm();
  }

  // 3. Ø¯Ø§Ù„Ø© Ù…Ù„Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙˆØ§ÙƒØªØ´Ø§Ù Ø­Ø§Ù„Ø© Ø§Ù„Ø·ÙŠØ§Ø±ÙŠÙ†
  function updateDriverDropdown(activeDriversSet) {
      const select = document.getElementById('driverSelect');
      const currentVal = select.value; // Ø¹Ø´Ø§Ù† Ù†Ø­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ù„Ùˆ Ø¨Ù†Ø¹Ù…Ù„ Ø±ÙŠÙØ±ÙŠØ´
      select.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø·ÙŠØ§Ø± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) --</option>';

      driversDB.forEach(d => {
          // Ù„Ùˆ Ø§Ù„Ø·ÙŠØ§Ø± Ø¯Ù‡ Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´ØºÙˆÙ„ÙŠÙ†
          const isBusy = activeDriversSet.has(d.name);
          const statusIcon = isBusy ? 'ğŸ”´' : 'ğŸŸ¢';
          const statusText = isBusy ? '(Ù…Ø¹Ù‡ Ø£ÙˆØ±Ø¯Ø±)' : '(Ù…ØªØ§Ø­)';
          
          const option = document.createElement('option');
          option.value = d.name;
          option.text = `${statusIcon} ${d.name} ${statusText}`;
          select.appendChild(option);
      });
      select.value = currentVal;
  }

  // 4. Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ø§Ø´Ø©
  onValue(ref(db, 'orders'), (snapshot) => {
      const list = document.getElementById('ordersList');
      list.innerHTML = '';
      const data = snapshot.val();
      allOrdersData = data || {};

      if(!data) { list.innerHTML = '<p class="text-center">Ù…ÙÙŠØ´ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù†Ù‡Ø§Ø±Ø¯Ø© Ù„Ø³Ù‡..</p>'; return; }

      const orders = Object.entries(data).reverse();
      
      // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø´ØºÙˆÙ„ÙŠÙ† Ø­Ø§Ù„ÙŠØ§Ù‹ (Ø£ÙŠ Ø­Ø¯ Ù…Ø¹Ø§Ù‡ Ø£ÙˆØ±Ø¯Ø± Ø­Ø§Ù„ØªÙ‡ new)
      const busyDrivers = new Set();
      orders.forEach(([key, o]) => {
          if(o.status === 'new' && o.driver) busyDrivers.add(o.driver);
      });
      updateDriverDropdown(busyDrivers); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙÙˆÙ‚
      calculateStats(orders); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§Ø­ØµØ§Ø¦ÙŠØ§Øª

      orders.forEach(([id, order]) => {
          // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø£Ù„ÙˆØ§Ù† ÙˆØ§Ù„Ø­Ø§Ù„Ø©
          let statusClass = 'status-pending';
          let statusText = 'âš ï¸ ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± (Ø¨Ø¯ÙˆÙ† Ø·ÙŠØ§Ø±)';
          
          if(order.status === 'new') { statusClass = 'status-new'; statusText = 'ğŸ›µ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙˆØµÙŠÙ„'; }
          if(order.status === 'done') { statusClass = 'status-done'; statusText = 'âœ… ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…'; }

          // ØªØ¬Ù‡ÙŠØ² Ø±Ø§Ø¨Ø· Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ (Web Whatsapp)
          let whatsappBtn = '';
          // Ø²Ø±Ø§Ø± Ø§Ù„ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø³Ø±ÙŠØ¹ Ù„Ùˆ Ù…Ø¹Ù„Ù‚
          let assignDriverUI = '';

          if(order.driver) {
              // Ù„Ùˆ ÙÙŠÙ‡ Ø·ÙŠØ§Ø±ØŒ Ù†Ø¬Ù‡Ø² Ø²Ø±Ø§Ø± Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨
              const driverObj = driversDB.find(d => d.name === order.driver);
              const driverPhone = driverObj ? driverObj.phone : ''; // Ù„Ùˆ Ø§Ù„Ø§Ø³Ù… Ù…Ø´ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
              const driverLink = `${SITE_URL}driver.html?id=${id}`;
              
              const msg = `*Ø£ÙˆØ±Ø¯Ø± Ø¬Ø¯ÙŠØ¯ ÙŠØ§ ${order.driver}* ğŸš€%0a` +
                          `ğŸª *Ù…Ù†:* ${order.storeName}%0a` +
                          `ğŸ§¾ *Ø§Ù„Ø£ÙˆØ±Ø¯Ø±:* ${order.details}%0a` +
                          `ğŸ’µ *Ø§Ù„ØªÙˆØµÙŠÙ„:* ${order.price} Ø¬.Ù…%0a` +
                          `ğŸ“ *Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„:* ${order.address}%0a` +
                          `ğŸ“ *Ù…ÙˆØ¨Ø§ÙŠÙ„:* ${order.clientPhone}%0a` +
                          `------------------%0a` +
                          `âœ… *Ø¯ÙˆØ³ Ù‡Ù†Ø§ Ù„Ù…Ø§ ØªØ³Ù„Ù…:* ${driverLink}`;
              
              if(order.status === 'new') {
                   // Ø±Ø§Ø¨Ø· web.whatsapp Ø§Ù„Ù…Ø¨Ø§Ø´Ø±
                   whatsappBtn = `<a href="https://web.whatsapp.com/send?phone=${driverPhone}&text=${msg}" target="whatsapp_window" class="btn btn-success btn-sm"><i class="fab fa-whatsapp"></i> Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø·ÙŠØ§Ø±</a>`;
              }
          } else {
              // Ù„Ùˆ Ù…ÙÙŠØ´ Ø·ÙŠØ§Ø± (Pending)
              // Ù†Ø¸Ù‡Ø± Ø²Ø±Ø§Ø± "ØªØ¹Ø¯ÙŠÙ„" Ø¨Ø´ÙƒÙ„ Ø£Ø³Ø§Ø³ÙŠ Ù„Ù„ØªØ¹ÙŠÙŠÙ†
               statusText += ` <button class="btn btn-outline-warning btn-sm ms-2" onclick="editOrder('${id}')">ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¢Ù†</button>`;
          }

          const html = `
              <div class="order-card ${statusClass}">
                  <div class="row align-items-center">
                      <div class="col-md-3 border-end">
                          <strong class="text-primary">${order.storeName}</strong><br>
                          <small class="text-muted">Ø§Ù„Ø³Ø¹Ø±: ${order.price || '-'} Ø¬</small>
                      </div>
                      <div class="col-md-4 border-end">
                          <strong>${order.details}</strong><br>
                          <small class="text-muted"><i class="fas fa-map-marker-alt"></i> ${order.address}</small>
                      </div>
                      <div class="col-md-3">
                          <span class="badge bg-secondary mb-1">${order.driver || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span><br>
                          <strong class="${order.status==='done'?'text-success':'text-warning'}">${statusText}</strong>
                      </div>
                      <div class="col-md-2 text-end">
                          ${whatsappBtn}
                          <button onclick="editOrder('${id}')" class="btn btn-outline-primary btn-sm mt-1"><i class="fas fa-edit"></i> ØªØ¹Ø¯ÙŠÙ„</button>
                      </div>
                  </div>
              </div>
          `;
          list.innerHTML += html;
      });
  });

  // 5. ÙˆØ¸ÙŠÙØ© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ (Edit)
  window.editOrder = function(id) {
      const order = allOrdersData[id];
      if(!order) return;

      document.getElementById('editOrderId').value = id;
      document.getElementById('storeName').value = order.storeName || '';
      document.getElementById('orderDetails').value = order.details || '';
      document.getElementById('deliveryPrice').value = order.price || '';
      document.getElementById('clientPhone').value = order.clientPhone || '';
      document.getElementById('address').value = order.address || '';
      document.getElementById('driverSelect').value = order.driver || '';

      // ØªØºÙŠÙŠØ± Ø´ÙƒÙ„ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
      document.getElementById('saveBtn').innerText = "ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ğŸ”„";
      document.getElementById('saveBtn').classList.remove('btn-primary');
      document.getElementById('saveBtn').classList.add('btn-warning');
      document.getElementById('cancelBtn').style.display = 'inline-block';
      document.getElementById('formTitle').innerText = "ğŸ“ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨";
      
      // Ù†Ø·Ù„Ø¹ Ù„ÙÙˆÙ‚
      window.scrollTo(0, 0);
  }

  // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
  window.cancelEdit = function() {
      clearForm();
      document.getElementById('editOrderId').value = '';
      document.getElementById('saveBtn').innerText = "Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨";
      document.getElementById('saveBtn').classList.add('btn-primary');
      document.getElementById('saveBtn').classList.remove('btn-warning');
      document.getElementById('cancelBtn').style.display = 'none';
      document.getElementById('formTitle').innerHTML = '<i class="fas fa-plus-circle"></i> Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯';
  }

  function clearForm() {
      document.getElementById('storeName').value = '';
      document.getElementById('orderDetails').value = '';
      document.getElementById('deliveryPrice').value = '';
      document.getElementById('clientPhone').value = '';
      document.getElementById('address').value = '';
      document.getElementById('driverSelect').value = '';
  }

  // 6. Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª (Analytics)
  function calculateStats(ordersArr) {
      const total = ordersArr.length;
      let done = 0;
      let driversCount = {};

      ordersArr.forEach(([k, o]) => {
          if(o.status === 'done') done++;
          if(o.driver) {
              driversCount[o.driver] = (driversCount[o.driver] || 0) + 1;
          }
      });

      let driversHtml = '';
      for (const [name, count] of Object.entries(driversCount)) {
          driversHtml += `<div class="col-md-2 mb-2"><div class="stats-card"><small>${name}</small><br><strong>${count}</strong></div></div>`;
      }

      document.getElementById('statsBar').innerHTML = `
          <div class="col-md-3 mb-2">
              <div class="stats-card border-primary">
                  <div class="text-muted">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ÙˆØ±Ø¯Ø±Ø§Øª</div>
                  <div class="stats-number">${total}</div>
              </div>
          </div>
          <div class="col-md-3 mb-2">
              <div class="stats-card border-success">
                  <div class="text-muted">ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…</div>
                  <div class="stats-number text-success">${done}</div>
              </div>
          </div>
          ${driversHtml}
      `;
  }

  // 7. ØªØµØ¯ÙŠØ± Ù„Ù„Ø¥ÙƒØ³ÙŠÙ„ (Export)
  window.exportToExcel = function() {
      const rows = [["Store", "Details", "Price", "Address", "Phone", "Driver", "Status", "Date"]];
      
      Object.values(allOrdersData).forEach(o => {
          const date = new Date(o.timestamp).toLocaleString('ar-EG');
          rows.push([
              o.storeName, o.details, o.price, o.address, o.clientPhone, o.driver, o.status, date
          ]);
      });

      let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; // Ù„Ø¯Ø¹Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
      rows.forEach(r => {
          const row = r.map(e => `"${e || ''}"`).join(",");
          csvContent += row + "\r\n";
      });

      const link = document.createElement("a");
      link.setAttribute("href", encodeURI(csvContent));
      link.setAttribute("download", "akhdemny_orders.csv");
      document.body.appendChild(link);
      link.click();
  }

</script>

</body>
</html>

